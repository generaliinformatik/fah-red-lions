<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-170461180-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());
		gtag('config', "UA-170461180-1", { 'anonymize_ip': true });
	</script>

	<style> /* set the CSS */
		body { font: 12px Arial;}
		.graph-svg-background {
			background-color: white;
		}
		path { 
			stroke: gray;
			stroke-width: 2;
			fill: none;
		}
		.xaxis {
			fill: none;
			stroke: grey;
			stroke-width: 1;
			shape-rendering: crispEdges;
			font: 12px sans-serif;
		}
		.yaxis {
			fill: none;
			stroke: grey;
			stroke-width: 1;
			shape-rendering: crispEdges;
			font: 12px sans-serif;
		}
		.line {
			fill: none;
			stroke: steelblue;
			stroke-width: 2px;
		}
		.x {
			stroke: lightgrey;
			stroke-opacity: 0.7;
			shape-rendering: crispEdges;
			font: 12px sans-serif;
			color: black;
		}
		.y {
			stroke: lightgrey;
			stroke-opacity: 0.7;
			shape-rendering: crispEdges;
			font: 12px sans-serif;
			color: black;
		}
		.zeroline {
			fill: none;
			stroke: darkgray;
			stroke-width: 0.5px;
			stroke-dasharray: 5 5;
		}
		.zerolinetext {
			fill: darkgray;
			font: 12px sans-serif;
		}
		.goalline {
			fill: none;
			stroke: darkred;
			stroke-width: 1.5px;
			stroke-dasharray: 5 5;
		}
		.goallinetext {
			fill: darkred;
			font: 12px sans-serif;
		}
		.lastvaluetext {
			fill: steelblue;
			font-weight: bold;
			font: 12px sans-serif;
		}

		td, th {
			padding: 1px 4px;
		}
	</style>
</head>

<body>
	<h1>Folding@Home - Team Red Insurance Lions ("Red Lions")</h1>
	<p>
		<h2>Verlauf</h2>
	</p>

	<div><button id='saveButton'>Export visualization to PNG</button></div>

<script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
<script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>

<script>

	var germanFormatters = d3.locale({
	"decimal": ",",
	"thousands": ".",
	"grouping": [3],
	"currency": ["€", ""],
	"dateTime": "%a %b %e %X %Y",
	"date": "%d.%m.%Y",
	"time": "%H:%M:%S",
	"periods": ["AM", "PM"],
	"days": ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"],
	"shortDays": ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
	"months": ["Jannuar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"],
	"shortMonths": ["Jan", "Feb", "Mär", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"]
	});

	var customTimeFormat = germanFormatters.timeFormat.multi([
		[".%L", function(d) { return d.getMilliseconds(); }],
		[":%S", function(d) { return d.getSeconds(); }],
		["%I:%M", function(d) { return d.getMinutes(); }],
		["%Hh", function(d) { return d.getHours(); }],
		["%a %d", function(d) { return d.getDay() && d.getDate() != 1; }],
		["%b %d", function(d) { return d.getDate() != 1; }],
		["%B", function(d) { return d.getMonth(); }],
		["%Y", function() { return true; }]
	]); 


	// Set the dimensions of the canvas / graph
	var	margin = {top: 30, right: 20, bottom: 30, left: 50},
		width = 600 - margin.left - margin.right,
		height = 270 - margin.top - margin.bottom;
	
	// Parse the date / time
	var	parseDate = d3.time.format("%Y-%m-%d %H:%M:%S").parse;
	
	// Set the ranges
	var	x = d3.time.scale().range([0, width-100]);
//	var	y = d3.scale.linear().range([height, 0]);
	var	y = d3.scale.linear().range([0,height]);
	
	// Define the axes
	var	xAxis = d3.svg.axis().scale(x)
		.orient("bottom").ticks(10)
		.tickFormat(customTimeFormat);
	
	var	yAxis = d3.svg.axis().scale(y)
		.orient("left").ticks(10);
	
	// Define the line
	var	valueline = d3.svg.line()
		.x(function(d) { return x(d.timestamp); })
		.y(function(d) { return y(d.rank); });
		
	// Adds the svg canvas
	var	svg = d3.select("body")
		.append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.attr("class", "graph-svg-background")
		.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
	

	// Get the data
	d3.csv("data/folding-stats.csv", function(error, data) {
		data.forEach(function(d) {
			d.timestamp = parseDate(d.timestamp);
			//d.rank = +(d.rank);
			d.rank = +(d.rank);
		});
	
		// Scale the range of the data
		x.domain(d3.extent(data, function(d) { return d.timestamp; }));
		y.domain([0, d3.max(data, function(d) { return d.rank; })]);
	
		// Add the valueline path.
		svg.append("path")	
			.attr("class", "line")
			.attr("d", valueline(data));
	
		// Add the X Axis
		svg.append("g")		
			.attr("class", "xaxis")
			.attr("transform", "translate(0," + height + ")")
			.call(xAxis);
	
		// Add the Y Axis
		svg.append("g")		
			.attr("class", "yaxis")
			.call(yAxis);

		svg.append('line')
					.attr('x1', 0)
					.attr('y1', y(10000))
					.attr('x2', width)
					.attr('y2', y(10000))
					.attr('class', 'zeroline');
		svg.append('text')
						.attr('x', width)
						.attr('y', y(10000))
						.attr('dy', '1em')
						.attr('text-anchor', 'end')
						.text("MS#1: 10000")
						.attr('class', 'zerolinetext');
		svg.append('line')
						.attr('x1', 0)
						.attr('y1', y(5000))
						.attr('x2', width)
						.attr('y2', y(5000))
						.attr('class', 'zeroline');
		svg.append('text')
						.attr('x', width)
						.attr('y', y(5000))
						.attr('dy', '1em')
						.attr('text-anchor', 'end')
						.text("MS#2: 5000")
						.attr('class', 'goallinetext');
		svg.append('line')
						.attr('x1', 0)
						.attr('y1', y(1000))
						.attr('x2', width)
						.attr('y2', y(1000))
						.attr('class', 'goalline');
		svg.append('text')
						.attr('x', width)
						.attr('y', y(1000))
						.attr('dy', '1em')
						.attr('text-anchor', 'end')
						.text("GOAL: 150")
						.attr('class', 'goallinetext');

		svg.append('text')
						.attr('x', width-80)
						.attr('y', y(d3.min(data, function(d) { return d.rank; })))
						.attr('dy', '1em')
						.attr('text-anchor', 'end')
						.text(d3.min(data, function(d) { return d.rank; }))
						.attr('class', 'lastvaluetext');

		});




		// Set-up the export button
d3.select('#saveButton').on('click', function(){
//	var svgString = getSVGString(svg.node());
	var svgString = getSVGString(d3.select('svg').node());
	
	svgString2Image( svgString, 2*width, 2*height, 'png', save ); // passes Blob and filesize String to the callback

	function save( dataBlob, filesize ){
		saveAs( dataBlob, 'rank.png' ); // FileSaver.js function
	}
});

// Below are the functions that handle actual exporting:
// getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
function getSVGString( svgNode ) {
	svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
	var cssStyleText = getCSSStyles( svgNode );
	appendCSS( cssStyleText, svgNode );

	var serializer = new XMLSerializer();
	var svgString = serializer.serializeToString(svgNode);
	svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
	svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

	return svgString;

	function getCSSStyles( parentElement ) {
		var selectorTextArr = [];

		// Add Parent element Id and Classes to the list
		selectorTextArr.push( '#'+parentElement.id );
		for (var c = 0; c < parentElement.classList.length; c++)
				if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
					selectorTextArr.push( '.'+parentElement.classList[c] );

		// Add Children element Ids and Classes to the list
		var nodes = parentElement.getElementsByTagName("*");
		for (var i = 0; i < nodes.length; i++) {
			var id = nodes[i].id;
			if ( !contains('#'+id, selectorTextArr) )
				selectorTextArr.push( '#'+id );

			var classes = nodes[i].classList;
			for (var c = 0; c < classes.length; c++)
				if ( !contains('.'+classes[c], selectorTextArr) )
					selectorTextArr.push( '.'+classes[c] );
		}

		// Extract CSS Rules
		var extractedCSSText = "";
		for (var i = 0; i < document.styleSheets.length; i++) {
			var s = document.styleSheets[i];
			
			try {
			    if(!s.cssRules) continue;
			} catch( e ) {
		    		if(e.name !== 'SecurityError') throw e; // for Firefox
		    		continue;
		    	}

			var cssRules = s.cssRules;
			for (var r = 0; r < cssRules.length; r++) {
				if ( contains( cssRules[r].selectorText, selectorTextArr ) )
					extractedCSSText += cssRules[r].cssText;
			}
		}
		

		return extractedCSSText;

		function contains(str,arr) {
			return arr.indexOf( str ) === -1 ? false : true;
		}

	}

	function appendCSS( cssText, element ) {
		var styleElement = document.createElement("style");
		styleElement.setAttribute("type","text/css"); 
		styleElement.innerHTML = cssText;
		var refNode = element.hasChildNodes() ? element.children[0] : null;
		element.insertBefore( styleElement, refNode );
	}
}


function svgString2Image( svgString, width, height, format, callback ) {
	var format = format ? format : 'png';

	var imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

	var canvas = document.createElement("canvas");
	var context = canvas.getContext("2d");

	canvas.width = width;
	canvas.height = height;

	var image = new Image();
	image.onload = function() {
		context.clearRect ( 0, 0, width, height );
		context.drawImage(image, 0, 0, width, height);

		canvas.toBlob( function(blob) {
			var filesize = Math.round( blob.length/1024 ) + ' KB';
			if ( callback ) callback( blob, filesize );
		});
	};

	image.src = imgsrc;
}

</script>
<div id="history">
	<h2>Historische Werte</h2>
	<script>
		var tabulate = function (data,columns) {
		var table = d3.select('#history').append('table')
		var thead = table.append('thead')
		var tbody = table.append('tbody')
	
		thead.append('tr')
			.selectAll('th')
			.data(columns)
			.enter()
			.append('th')
			.text(function (d) { return d })
	
		var rows = tbody.selectAll('tr')
			.data(data)
			.enter()
			.append('tr')
	
		var cells = rows.selectAll('td')
			.data(function(row) {
				return columns.map(function (column) {
					return { column: column, value: row[column] }
				})
			})
			.enter()
		.append('td')
			.text(function (d) { return d.value })
	
		return table;
	}
	
	d3.csv('data/folding-stats.csv',function (data) {
		var columns = ['timestamp','team','rank']
		tabulate(data,columns)
	})
	</script>
</div>

</body>
</html>